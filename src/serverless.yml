service: timeout-api

provider:
  name: aws
  runtime: go1.x
  lambdaHashingVersion: 20201221

  stage: dev
  region: eu-west-1

  iamRoleStatements:
  - Effect: Allow
    Action:
      - dynamodb:GetItem
      - dynamodb:PutItem
    Resource: arn:aws:dynamodb:*:*:table/${self:custom.latencyTable}
  - Effect: Allow
    Action:
      - s3:GetItem
      - s3:PutItem
    Resource: arn:aws:s3:::${self:custom.latencyBucket}
  - Effect: Allow
    Action:
      - lambda:InvokeFunction
    Resource: arn:aws:lambda:*:*:function:*
  - Effect: Allow
    Action:
      - sqs:DeleteMessage
      - sqs:ReceiveMessage
    Resource: arn:aws:sqs:*:*:${self:custom.timeoutTransactions}

package:
  patterns:
    - '!./**'
    - ./bin/**

custom:
  region: ${self:provider.region}
  prefix: ${self:provider.stage}-${self:service}
  timeoutTransactions: ${self:custom.prefix}-timeout-transactions
  latencyBucket: ${self:custom.prefix}-transaction-latencies
  latencyTable: ${self:custom.prefix}-transaction-latencies-table

functions:
  # get-verifications:
  #   handler: bin/world
  #   description: Verify transactions from API and DynamoDb object query.
  #   events:
  #     - httpApi:
  #         path: /verify
  #         method: get
  #   environment:
  #     latencyTable: ${self:custom.latencyTable}
  #     latencyBucket: ${self:custom.latencyBucket}

  create-latency-table-objects:
    handler: bin/latency-api
    description: Fill DynamoDb latencies table with latency country API latency data objects.
    events:
      - s3: ${self:custom.latencyBucket}
    environment:
      latencyTable: ${self:custom.latencyTable}
      latencyBucket: ${self:custom.latencyBucket}

  verification-api:
    handler: bin/verification-api
    description: Verify transactions from API and DynamoDb object query.
    events:
      - httpApi:
          path: /verify
          method: get
    environment:
      latencyTable: ${self:custom.latencyTable}
      latencyBucket: ${self:custom.latencyBucket}

resources:
  Resources:
    Transactions:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.timeoutTransactions}
        MessageRetentionPeriod: 1209600
        VisibilityTimeout: 60
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
            - MessagesDeadLetterQueue
            - Arn
          maxReceiveCount: 10

    MessagesDeadLetterQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.timeoutTransactions}-dead-letter-queue
        MessageRetentionPeriod: 1209600

    Verification:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.latencyTable}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5

    # LatencyBucket:
    #   Type: AWS::S3::Bucket
    #   Properties:
    #     BucketName: ${self:custom.latencyBucket}
